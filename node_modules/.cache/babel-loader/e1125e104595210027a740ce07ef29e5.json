{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\n\nvar errors_1 = require(\"@ledgerhq/errors\");\n\nvar Tag = 0x05;\n\nfunction asUInt16BE(value) {\n  var b = Buffer.alloc(2);\n  b.writeUInt16BE(value, 0);\n  return b;\n}\n\nvar initialAcc = {\n  data: Buffer.alloc(0),\n  dataLength: 0,\n  sequence: 0\n};\n/**\n *\n */\n\nvar createHIDframing = function createHIDframing(channel, packetSize) {\n  return {\n    makeBlocks: function makeBlocks(apdu) {\n      var data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n      var blockSize = packetSize - 5;\n      var nbBlocks = Math.ceil(data.length / blockSize);\n      data = Buffer.concat([data, Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0)]);\n      var blocks = [];\n\n      for (var i = 0; i < nbBlocks; i++) {\n        var head = Buffer.alloc(5);\n        head.writeUInt16BE(channel, 0);\n        head.writeUInt8(Tag, 2);\n        head.writeUInt16BE(i, 3);\n        var chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n        blocks.push(Buffer.concat([head, chunk]));\n      }\n\n      return blocks;\n    },\n    reduceResponse: function reduceResponse(acc, chunk) {\n      var _a = acc || initialAcc,\n          data = _a.data,\n          dataLength = _a.dataLength,\n          sequence = _a.sequence;\n\n      if (chunk.readUInt16BE(0) !== channel) {\n        throw new errors_1.TransportError(\"Invalid channel\", \"InvalidChannel\");\n      }\n\n      if (chunk.readUInt8(2) !== Tag) {\n        throw new errors_1.TransportError(\"Invalid tag\", \"InvalidTag\");\n      }\n\n      if (chunk.readUInt16BE(3) !== sequence) {\n        throw new errors_1.TransportError(\"Invalid sequence\", \"InvalidSequence\");\n      }\n\n      if (!acc) {\n        dataLength = chunk.readUInt16BE(5);\n      }\n\n      sequence++;\n      var chunkData = chunk.slice(acc ? 5 : 7);\n      data = Buffer.concat([data, chunkData]);\n\n      if (data.length > dataLength) {\n        data = data.slice(0, dataLength);\n      }\n\n      return {\n        data: data,\n        dataLength: dataLength,\n        sequence: sequence\n      };\n    },\n    getReducedResult: function getReducedResult(acc) {\n      if (acc && acc.dataLength === acc.data.length) {\n        return acc.data;\n      }\n    }\n  };\n};\n\nexports[\"default\"] = createHIDframing;","map":{"version":3,"mappings":"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","names":["Tag","asUInt16BE","value","b","Buffer","alloc","writeUInt16BE","initialAcc","data","dataLength","sequence","createHIDframing","channel","packetSize","makeBlocks","apdu","concat","length","blockSize","nbBlocks","Math","ceil","fill","blocks","i","head","writeUInt8","chunk","slice","push","reduceResponse","acc","readUInt16BE","errors_1","readUInt8","chunkData","getReducedResult","exports"],"sourceRoot":"","sources":["../src/hid-framing.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}